#{if canView == true}
#{extends 'planLayout.html' /}
#{/if}
#{set title:'View Plan as List' /}

#{if canView == false}
#{extends 'main.html' /}
<h3>You are not allowed to view this plan.</h3>
#{/if}
#{else}
<br/> 

#{if isOrganizer == true}
<form action="@{VolunteerRequests.viewVolunteerRequests()}" method="post">
	<input type = "hidden" name = "planId" value = ${p.id} >
    Volunteer Requests: <input type="submit" value="View Volunteer Requests">
</form> 
#{/if}
#{if canEdit == 1}
<a href="@{Plans.editPlan(p.id)}">Edit General info about the plan</a>
<a href="@{Plans.deletePlan(p.id)}">Delete the plan</a>
#{/if}
#{if canIdea == 1}
<form action="@{Plans.addIdea()}" method="post">
<input type = "hidden" name = "planId" value = ${p.id} >
<input type="submit" value="Associate ideas to this plan">
</form>
#{/if}
<br/>
<form action="@{Plans.planView()}" method="post">
<input type = "hidden" name = "planId" value = ${p.id} >
<input type="submit" value="View the list of ideas associated to this plan">
</form>
<br/>
		<form action="@{Plans.rate(p.id,rat)}" method="GET">
			<input type="submit" value="Submit rating"/>
			<input type="hidden" name = "planId" value=${p.id}/>
			<select name="rat">
				<option value="0">0</option>
				<option value="1">1</option>
				<option value="2">2</option>
				<option value="3">3</option>
				<option value="4">4</option>
				<option value="5">5</option>
			</select>
		</form>
<br />
		<form action="@{Plans.sharePlan()}" method="GET">
			<input type="submit" value="Share with user" />
			<input type="hidden" name = "planID" value=${p.id}/>
			<input type="text" name="userName" id="userToShareWith"/>
		</form>
 		<br />
		<form action="@{Comments.addCommentToPlan()}" method="GET">
		<input type = "text" name = "comment">
        <input type = "hidden" name = "planId" value = ${p.id} >
		<input type = "submit" value = "Comment" >
	</form>
	<br/>
		<input type = "submit" value = "Show Comments" onclick="viewComments()" >
		<br/>
		<script type="text/javascript">
			function viewComments(){
				
				document.getElementById('div1').innerHTML = "#{if comments} Comments <br/> <ul> #{list comments, as:'comment'} <li><a>${comment.toString()}</a></li> #{/list} <br/></ul> #{/if} #{else}No comments posted#{/else}"
			}
			</script>
	
	<div id='div1' align='left'>
</div>
#{if itemsList.size() > 0}
<ul style="list-style: none; ">
    #{list items:itemsList, as:'item'}
    <li id = "listItem_${item.id}">
        <fieldset>
            <legend>
                <h2>
                ${item.summary}</a>
            </h2>
            </legend>
            Item Description: ${item.description}
            <br/>
			Status: #{if item.status == 0}New
			#{/if}
			#{else}
			#{if item.status == 1} In Progress
			#{/if}
			#{else}
			#{if item.status == 2}Done
			#{/if}
			#{/else}
			#{/else}
			<br/>
            Start Date:  ${item.startDate.format('dd MMM yy')}
            <br/>
            End Date:  ${item.endDate.format('dd MMM yy')}
			&nbsp;&nbsp;
			#{if item.endDatePassed()}
			The end date has passed!
			#{/if}
            <br/>
			
			 <ul id = "assignees_${item.id}" style="list-style: none; ">
            #{if item.assignees.size() > 0}
			Assigned Users: 
                #{list items:item.getAssignees(), as:'assignedUser'}
                <li>
                    <a href="#">${assignedUser.username}</a>
                </li>
                #{/list}
			#{/if}
			 </ul>
		 #{if user.canWork(item.id) && !(item.status == 2) && !item.endDatePassed()}
   		<input type="button" id = "buttonWork_${item.id}" onclick="workItem(${item.id},'${user.username}');"  value = "work on this item"> 
     	<br/>
  		#{/if}
			#{if canAssign == 1 && !(item.status == 2)&& !item.endDatePassed()}
		<form action="@{AssignRequests.assign(item.id, p.id)}" method="post">
		<input type="submit" value="assign a user to this item">
		</form>
      #{/if}
		 #{if canEdit == 1}
		<form action="@{Plans.editItem(item.id)}" method="post">
		<input type="submit" value="Edit this item">
		</form>
      #{/if}
	  	 #{if canEdit == 1}
		<input type="button" onclick="delItem(${item.id});" value = "delete item"> 
		<br/>
      #{/if}
	  
		  #{if isOrganizer == true}
	#{if item.isRelatedToEntity() == true} 
	<div id = "removeEntity_${item.id}">
	Related to entity: ${item.relatedEntity}
	<input type = "button" value = "Remove" onclick="remove_entity(${item.id});">
	</div>
	#{/if}
	#{else} <div id = "relateEntity_${item.id}">
	Relate to entity: 
	  <select name="entity" id="entitySelect" >
   		 #{list items:entitiesList, as:'ent'}
 		 <option value = ${ent.id}>${ent.name}</option>
		 #{/list}
	  </select>
	  
	  <input type = "button" value = "Relate" onclick="relate_entity(${item.id});">
	</div>
	#{/else}
	 <div id = "entity_div"></div>
	 #{/if}
	  
	  #{if user.pendingVolunteerRequest(item.id)}
	   <label>Pending volunteer Request</label>
	  #{/if}
	  <label id = "label_${item.id}"></label>
        #{if user.canVolunteer(item.id) && !(item.status == 2) && !item.endDatePassed()}
		<input type="button" onclick="show1(${item.id});" id = "button_${item.id}" value = "volunteer"> 
   		<div id = "item_${item.id}" class = "req">
   			Please state why you want to work on this item.
			<br/>
				<textarea id = "text_${item.id}" rows="7" cols="50"> </textarea>   
				<span><font color="Red">*</font>Required</span>
					<br/>
				<input type="button" onclick="send(${item.id});" value = "send request"> 
		&nbsp;&nbsp;&nbsp;
			<input type="button" onclick="cancel(${item.id});" value = "cancel"> 
			
		</div>
     	<br/>
  		#{/if}
        </fieldset>
    </li>
    #{/list}
</ul>
#{if canEdit == 1}
		<a href="@{Plans.addItem(p.id)}">Add item(s)</a>
 #{/if}
#{/if} 
#{else}  
No items exist in plan. Please contact 
#{if p.topic.getOrganizer().size() > 1} 
<ul style="list-style: none; ">
	    #{list items:p.topic.getOrganizer(), as:'organizer'}
	    <li>
	        <a href="#">${organizer.username}</a>
	    </li>
	    #{/list}
	</ul>
	#{/if} 
	#{else}
	${p.topic.getOrganizer().get(0).username}
	#{/else}
#{/else}
#{/else}
<script type="text/javascript">
	$(".req").hide();
	  var count = ${itemsList.size()};
	function show1(id) {

	    $("#item_" + id).show();
		$("#button_" + id).hide();

	}
	
		function send(id) {
					var x = $("#text_" + id).val();
		if (x == null || x.trim() == "") {
			alert("you have to enter a justification");
		}
		else {
			$.post('@{sendVolunteerRequest()}', {
				itemId: id,
				justification: x
			});
			$("#item_" + id).remove();
			document.getElementById("label_" + id).innerHTML = "pending volunteer request";	
		}	
	}	
	
		
		function cancel(id) {
		$("#item_" + id).hide();
	    $("#button_" + id).show();		
	}
	
		function workItem(id,name) {
			$.post('@{workOnItem()}', {itemId:id});
			$("#buttonWork_" + id).remove();
		    $("#assignees_" + id).append('<li> <a href="#">'+name+'</a> </li>');
	}	
	
	function delItem(id){
		var r = confirm("Are You sure you want to delete this item from the plan?");
		if (r == true) {
			$.post('@{deleteItem()}', {itemId: id, notify:1});
			$("#listItem_" + id).remove();
			  count--;
			  if(count == 0) {
			  	 alert("you have deleted all the items in the plan");
			  }
	            
		}

	}



</script>	
			
function remove_entity(item)
  {
  	$.post('@{removeItemEntityRelation()}' , {itemId: item});
	$("#removeEntity_" + item).hide();
	
	document.getElementById('entity_div').innerHTML = "Relate to entity: 
	  <select name="entity" id="entitySelect" >
    #{list items:entitiesList, as:'ent'}
 		 <option value = ${ent.id}>${ent.name}</option>
		 #{/list}
	  </select>
	  
	  <input type = "button" value = "Relate" onclick="relate_entity(${item.id});">"
  }
</script>