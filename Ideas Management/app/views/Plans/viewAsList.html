#{extends 'planLayout.html' /}
#{set 'title'}
${p.title} - View Plan as List
#{/set}
<script language="javascript" type="text/javascript" src="/public/javascripts/autocomplete.js"></script>
<br/>
#{if checkNotRated}
<form action="@{Plans.rate(p.id,rat)}" method="GET">
    <input type="submit" value="Submit rating"/><input type="hidden" name = "planId" value=${p.id}/>
    <select name="rat">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
    </select>
</form>
#{/if}
#{else}
You have already rated this plan
#{/else}
<br/>
<form action="@{Plans.sharePlan()}" method="GET">
    <input type="submit" value="Share with user" /><input type="hidden" name = "planID" value=${p.id}/><input type="text" name="userName" id="userToShareWith"/>
</form>
<br/>
<form action="@{Comments.addCommentToPlan()}" method="GET">
    <input type = "text" name = "comment"><input type = "hidden" name = "planId" value = ${p.id}><input type = "submit" value = "Comment">
</form>
<br/>
<input type = "submit" value = "Show Comments" onclick="viewComments()">
<br/>
<script type="text/javascript">
    function viewComments(){
    
        document.getElementById('div1').innerHTML = "#{if comments} Comments <br/> <ul> #{list comments, as:'comment'} <li><a>${comment.toString()}</a></li> #{/list} <br/></ul> #{/if} #{else}No comments posted#{/else}"
    }
</script>
<div id='div1' align='left'>
</div>
#{if itemsList.size() > 0}
<br>
To-do items: 
<br>
<ul style="list-style: none; ">
    #{list items:itemsList, as:'item'}
    <li id = "listItem_${item.id}">
        <br/>
        <fieldset style="width:650px;">
            <legend>
                <h2>
                ${item.summary}
            </h2>
            </legend>
            Item Description: ${item.description}
            <br/>
            Status: #{if item.status == 0}New
            #{/if}
            #{else}
            #{if item.status == 1} In Progress
            #{/if}
            #{else}
            #{if item.status == 2}Done
            #{/if}
            #{/else}
            #{/else}
            <br/>
            Start Date:  ${item.startDate.format('dd MMM yy')}
            <br/>
            End Date:  ${item.endDate.format('dd MMM yy')}
            &nbsp;&nbsp;
            #{if item.endDatePassed()}
            The end date has passed!
            #{/if}
            <br/>
            <ul id = "assignees_${item.id}" style="list-style: none; ">
                #{if item.assignees.size() > 0} 
                Assigned Users: 
                #{list items:item.getAssignees(), as:'assignedUser'}
                <li>
                    <a href="#">${assignedUser.username}</a>
                </li>
                #{/list}
                #{/if}
            </ul>
            #{if user.canWork(item.id) && !(item.status == 2) && !item.endDatePassed()}<input type="button" id = "buttonWork_${item.id}" onclick="workItem(${item.id},'${user.username}');" value = "work on this item">
            <br/>
            #{/if}
            #{if canAssign == 1 && !(item.status == 2)&& !item.endDatePassed()}
            <form action="@{AssignRequests.assign(item.id, p.id)}" method="post">
                <input type="submit" value="assign a user to this item">
            </form>#{/if}
            #{if canEdit == 1}
            <form action="@{Plans.editItem(item.id)}" method="post">
                <input type="submit" value="Edit this item">
            </form>#{/if}
            #{if canEdit == 1}<input type="button" onclick="delItem(${item.id});" value = "delete item">
            <br/>
            #{/if}
			 #{if canEdit == 1}
			 <form onsubmit=$('item.id'); method="post">
                    <input type="hidden" id='tags' name="tags" value="${listOfTags}">Tag the item
                    <br>
                    Tag: <input type="text" id="tag" name="tag" autoComplete="group"/>
                    <br> 
			  #{/if}
			  <script language="javascript" type="text/javascript">
                        var a = document.getElementById('listOfTags');
                        b = a.value + "";
                        c = b.split("|");
                        autoComplete.Set("group", c);
                    </script>
					
			 <form action="@{Plans.tagItem(item.id,tag)}" method="post">
					<input type="submit" value="Tag"/>
				 #{if tagAlreadyExists == true}	
				 alert('tag already exists');
				 #{else newTag==true}
				 alert('New Tag is created');
				 #{/else}
				   #{/if}
				  
					
			</form>
            #{if isOrganizer == true}  
            #{if item.isRelatedToEntity() == true} 
            <div id = "removeEntity_${item.id}">
                Related to entity: <a href="@{MainEntitys.viewEntity(item.relatedEntity.id)}">${item.relatedEntity}</a>
                <input type = "button" value = "Remove" onclick="remove_entity(${item.id});">
            </div>
			#{/if} 
            #{else} 
            <div id = "relateEntity_${item.id}">
                Relate to entity: 
                <select name="entity" id="entitySelect">
                    #{list items:entitiesList, as:'ent'}<option value = ${ent.id}>${ent.name}</option>
                    #{/list}
                </select>
                <input type = "button" value = "Relate" onclick="relate_entity(${item.id});">
            </div>
			#{/else}
            #{/if}
                <div id = "pend_${item.id}" hidden = true>
				Pending volunteer Request &nbsp;&nbsp;&nbsp;
				 <input type = "button" value = "Cancel request" onclick="cancelReq(${item.id});">
				 </div>
		 #{if user.pendingVolunteerRequest(item.id)&& !(item.status == 2) && !item.endDatePassed()}
		 			<script type="text/javascript">
				$('#pend_' + ${item.id}).show();			
				</script>
            #{/if}
            <div id = "label_${item.id}">
            </div>
            
			<div id = "vr_${item.id}" hidden = true>
			<input type="button" onclick="show1(${item.id});" id = "button_${item.id}" value = "volunteer">
            <div id = "item_${item.id}" class = "req">
                Please state why you want to work on this item.
                <br/>
                <textarea id = "text_${item.id}" rows="7" cols="50">
                </textarea>
                <span>
                    <font color="Red">
                        *
                    </font>Required
                </span>
                <br/>
                <input type="button" onclick="send(${item.id});" value = "send request">&nbsp;&nbsp;&nbsp;<input type="button" onclick="cancel(${item.id});" value = "cancel">
            </div>
            <br/>
			</div>
			#{if user.canVolunteer(item.id) && !(item.status == 2) && !item.endDatePassed()}
			<script type="text/javascript">
				$('#vr_' + ${item.id}).show();			
				</script>
            #{/if}
        </fieldset>
    </li>
    #{/list}
</ul>

#{/if}  
#{else} 
No items exist in plan. Please contact  
#{if p.topic.getOrganizer().size() > 1} 
<ul style="list-style: none; ">
    #{list items:p.topic.getOrganizer(), as:'organizer'}
    <li>
        <a href="#">${organizer.username}</a>
    </li>
    #{/list}
</ul>
#{/if} 
#{else}
${p.topic.getOrganizer().get(0).username}
#{/else}
#{/else}
<script type="text/javascript">
                	$(".req").hide();
                	  var count = ${itemsList.size()};
                	function show1(id) {
                
                	    $("#item_" + id).show();
                		$("#button_" + id).hide();
                
                	}
                	
                		function send(id) {
                					var x = $("#text_" + id).val();
                		if (x == null || x.trim() == "") {
                			alert("you have to enter a justification");
                		}
                		else {
                			$.post('@{sendVolunteerRequest()}', {
                				itemId: id,
                				justification: x
                			});
                			$("#item_" + id).hide();
							$('#pend_' + id).show();
                			//document.getElementById("label_" + id).innerHTML = "pending volunteer request" + " <input type = \"button\" value =\"Cancel request\" onclick=\"cancelReq(${item.id});\">";	
                		}	
                	}	
                	
					function cancelReq(id) {
				     var r = confirm("Are You sure you want to cancel your request?");
                		if (r == true) {
                			$.post('@{cancelVolunteerRequest()}', {itemId: id});
                			$('#vr_' + id).show();	
							$('#pend_' + id).hide();
                		}
					}
                		
                		function cancel(id) {
                		$("#item_" + id).hide();
                	    $("#button_" + id).show();		
                	}
                	
                		function workItem(id,name) {
                			$.post('@{workOnItem()}', {itemId:id});
                			$("#buttonWork_" + id).remove();
                		    $("#assignees_" + id).append('<li> <a href="#">'+name+'</a> </li>');
                	}	
                	
                	function delItem(id){
                		var r = confirm("Are You sure you want to delete this item from the plan?");
                		if (r == true) {
                			$.post('@{deleteItem()}', {itemId: id, notify:1});
                			$("#listItem_" + id).remove();
                			  count--;
                			  if(count == 0) {
                			  	 alert("you have deleted all the items in the plan");
                			  }
                	            
                		}
                
                	}
               
 					 function relate_entity(item)
 						{
                           var entity = document.getElementById('entitySelect').value;
                           $.post('@{relateToEntity()}' , {itemId: item, entityId: entity}, function(){window.location.reload();});        	
                         }
                                      
					 function remove_entity(item)
                        {
                       		var r = confirm("Are You sure you want to remove this relationship?");
                            if (r == true) {
								$.post('@{removeItemEntityRelation()}', {itemId: item}, function(){window.location.reload();});
							}
                          }
</script>
